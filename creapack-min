local a={...}local function b(c,d)print("")local e,f=term.getCursorPos()term.setCursorPos(1,f)term.write("[ ] ")term.setTextColor(d)term.write(c)return{oldY=f,complete=function(self)term.setCursorPos(1,self.oldY)local g=term.getTextColor()term.setTextColor(colors.green)term.write("[+] ")term.setTextColor(g)end,err=function(self)local h=f;term.setCursorPos(1,self.oldY)local g=term.getTextColor()term.setTextColor(colors.red)term.write("[x] ")term.setTextColor(g)end}end;local function i()local j=fs.open("/.creapack.json","r")local k=textutils.unserializeJSON(j.readAll())j.close()return{["name"]=k.name,["token"]=k.token}end;local function l()if fs.exists("/.creapack.json")then local m=i()print("[CP-AUTH] Logined as "..m.name)else error("[CP-AUTH] Unauthorized! Please login via 'creapack login' ",0)end end;local function n(o)local p,q=o:match("([^@]+)@([^@]+)")if p and q then return p,q else return o,nil end end;local function r(s)local t={}local u="shell%.run%('%s*wget%s+(.-)%s+(.-)%s*'%)"for v,w in string.gmatch(s,u)do v=v:gsub("^%s*(.-)%s*$","%1")w=w:gsub("^%s*(.-)%s*$","%1")t[w]=v end;return t end;local function x(y,q)local z=shell.getRunningProgram()local p=y;local A=fs.getDir(z)local B={name=a.package_name}print("Installing "..p.."...")local C=http.get("https://creapack.kiefe.ru/install?package_name="..p.."&version="..q,{["Content-Type"]="application/json"})local D=textutils.unserializeJSON(C.readAll()).data;if D.message then print("")error("[ERR] "..D.message,0)else print("")print("Found "..p.." version: "..(q or"latest").." !")end;local E,F=pcall(function()if fs.exists('/packages/'..p)==false then fs.makeDir('/packages/'..p)else fs.delete('/packages/'..p)fs.makeDir('/packages/'..p)end;sleep(0.1)C=http.get(D.install_url)local G=r(C.readAll())for w,v in pairs(G)do local j=fs.open('/packages/'..p.."/"..w,"w")local H=http.get(v)j.write(H.readAll())j.close()print("Installed : "..w)end end)sleep(0.8)print("Installed! Cheking dependecies...")print("")print(" ")if fs.exists('/packages/'..p.."/package.json")==false then error("Somehow package.json is not found! :-(",0)end;local j=fs.open('/packages/'..p.."/package.json","r")local k=nil;if j then k=textutils.unserializeJSON(j.readAll())j.close()else error("Critical error when reading a package.json ( maybe file not found ... )",0)end;if k and k.dependecies~=textutils.empty_json_array then print("Required dependecies: ")for I,J in pairs(k.dependecies)do print(" - "..I.." : "..J)end;sleep(1)print(" Installing them...")for I,J in pairs(k.dependecies)do x(I,J)end end;print("Dependency "..p.." was installed!")sleep(0.5)shell.run("cd "..A)term.clear()term.setCursorPos(1,1)end;local function K(p,q,L)local E,F=pcall(function()if fs.exists("/packages/"..p.."/")then local C;if q then C=http.get("https://creapack.kiefe.ru/check_update?package_name="..p.."&version="..q,{["Content-Type"]="application/json"})else C=http.get("https://creapack.kiefe.ru/check_update?package_name="..p,{["Content-Type"]="application/json"})end;local D=textutils.unserializeJSON(C.readAll()).data;local M=http.get(D.install_url)local N=textutils.unserializeJSON(M.readAll()).data;D.install=N.install_url;if D.message then print("")term.setTextColor(colors.red)print("[ERR] Can't connect to crepack! ("..D.message..")",0)print("Skipping install!")term.setTextColor(colors.white)sleep(2)else local z=shell.getRunningProgram()local A=fs.getDir(z)if A==""then A="/"end;local E,F=pcall(function()local j=fs.open("/packages/"..p.."/package.json","r")local k=textutils.unserializeJSON(j.readAll())j.close()if k.version~=D.version then if q then x(p,q)else x(p,"latest")end end end)if E==false then error("Cannot read the package.json and reinstall dependecy! ( "..F.." )",0)end;shell.run("cd "..A)term.clear()term.setCursorPos(1,1)end else local z=shell.getRunningProgram()local A=fs.getDir(z)local B={name=a.package_name}print("Installing "..p.."...")local C;if q then x(p,q)else x(p,"latest")end;shell.run("cd "..A)term.clear()term.setCursorPos(1,1)end end)if E==false then error("[CP-ERR] "..F,0)elseif E==true then local O=require(".packages/"..p)return O end end;return{import=K}
